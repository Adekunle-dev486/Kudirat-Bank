<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kudirat Wallet - Verify</title>
<style>
  /* Add this to the top of your CSS in all pages */
:root {
  --bg-primary: #0e0e0e;
  --bg-secondary: #1e1e1e;
  --bg-card: #1e1e1e;
  --text-primary: #ffffff;
  --text-secondary: #bbbbbb;
  --text-muted: #999999;
  --accent: #00ffae;
  --accent-secondary: #00b86b;
  --border: #333333;
  --input-bg: #1e1e1e;
  --shadow: rgba(0, 0, 0, 0.5);
}
/* Light Mode */
body.light {
  --bg-primary: #ffffff;
  --bg-secondary: #f5f5f5;
  --bg-card: #ffffff;
  --text-primary: #000000;
  --text-secondary: #666666;
  --text-muted: #999999;
  --accent: #00b86b;
  --accent-secondary: #00b86b;
  --border: #e0e0e0;
  --input-bg: #f0f0f0;
  --shadow: rgba(0, 0, 0, 0.1);
}
  body {
    margin: 0;
    font-family: "Segoe UI", sans-serif;
     background-color: var(--bg-primary);
       color: var(--text-primary);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    min-height: 100vh;
    padding-top: 40px;
  }
  .container {
    width: 90%;
    max-width: 400px;
    text-align: center;
  }
  .logo img { width: 150px; margin-bottom: 20px; }
  h2 { font-size: 1.4rem; margin-bottom: 10px; color: var(--text-primary); }
  p { font-size: 14px; color: var(--text-secondary); margin-bottom: 20px; }
  .code-input {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 20px;
  }
  .code-input input {
    width: 45px;
    height: 55px;
    font-size: 24px;
    text-align: center;
    background: var(--input-bg);
    border: 1px solid var(--accent);
    border-radius: 10px;
    color: var(--text-primary);
    outline: none;
  }
  .verify-btn {
    background: var(--accent-secondary);
    width: 100%;
    padding: 14px;
    border: none;
    border-radius: 30px;
    color: white;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    opacity: 0.5;
    pointer-events: none;
    margin-bottom: 15px;
  }
  .resend {
    color: var(--accent);
    font-size: 14px;
    cursor: pointer;
  }
  .error {
    color: red;
    font-size: 13px;
    margin-top: 5px;
    display: none;
  }
</style>
<!-- Add this to the <head> of all your HTML pages -->
<script>
// Theme Management System
const ThemeManager = {
  init() {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    this.applyTheme(savedTheme);
    
    // Set initial toggle state if toggle exists on page
    const darkModeToggle = document.getElementById('darkMode');
    if (darkModeToggle) {
      darkModeToggle.checked = savedTheme === 'dark';
    }
  },
  
  applyTheme(theme) {
    if (theme === 'light') {
      document.body.classList.add('light');
    } else {
      document.body.classList.remove('light');
    }
    localStorage.setItem('theme', theme);
  },
  
  toggle() {
    const currentTheme = document.body.classList.contains('light') ? 'light' : 'dark';
    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
    this.applyTheme(newTheme);
    
    // Update toggle state if it exists
    const darkModeToggle = document.getElementById('darkMode');
    if (darkModeToggle) {
      darkModeToggle.checked = newTheme === 'dark';
    }
  }
};
// Initialize theme on page load
document.addEventListener('DOMContentLoaded', () => {
  ThemeManager.init();
});
</script>
</head>
<body>
<div class="container">
  <div class="logo">
    <img src="./kudirat-logo.png" alt="Kudirat Logo" />
  </div>
  <h2>Verify your phone</h2>
  <p>Enter the 6-digit code sent to <span id="phoneDisplay"></span></p>
  <div class="code-input">
    <input type="text" maxlength="1">
    <input type="text" maxlength="1">
    <input type="text" maxlength="1">
    <input type="text" maxlength="1">
    <input type="text" maxlength="1">
    <input type="text" maxlength="1">
  </div>
  <div class="error" id="errorMsg">Invalid code. Please try again.</div>
  <button class="verify-btn" disabled>Verify</button>
  <div class="resend" id="resendBtn">Resend Code (<span id="timer">30</span>s)</div>
</div>
<script>
window.addEventListener('DOMContentLoaded', () => {
  // Get DOM elements
  const phoneDisplay = document.getElementById("phoneDisplay");
  const inputs = document.querySelectorAll(".code-input input");
  const verifyBtn = document.querySelector(".verify-btn");
  const errorMsg = document.getElementById("errorMsg");
  const resendBtn = document.getElementById("resendBtn");
  const timerDisplay = document.getElementById("timer");
  
  // Get user data from localStorage
  const phone = localStorage.getItem("currentUserPhone");
  const correctCode = localStorage.getItem("verificationCode");
  const accountNumber = localStorage.getItem("accountNumber");
  
  // Debug information
  console.log("Debug - Phone:", phone);
  console.log("Debug - Code:", correctCode);
  console.log("Debug - Account Number:", accountNumber);
  console.log("Debug - All Users:", JSON.parse(localStorage.getItem("kudiratUsers") || "[]"));
  
  // Check if required data exists
  if (!phone || !correctCode) {
    console.error("Missing phone or verification code");
    window.location.href = "register.html";
    return;
  }
  
  // Check if verification code has expired
  const codeExpiry = localStorage.getItem("verificationCodeExpiry");
  if (codeExpiry && new Date().getTime() > parseInt(codeExpiry)) {
    errorMsg.textContent = "Verification code expired. Please request a new one.";
    errorMsg.style.display = "block";
    return;
  }
  
  // Display user's phone number
  phoneDisplay.textContent = phone;
  
  // Auto move focus between inputs
  inputs.forEach((input, index) => {
    input.addEventListener("input", () => {
      if (input.value && index < inputs.length - 1) {
        inputs[index + 1].focus();
      }
      checkCodeFilled();
    });
    
    input.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && !input.value && index > 0) {
        inputs[index - 1].focus();
      }
    });
  });
  
  // Check if all code fields are filled
  function checkCodeFilled() {
    const code = Array.from(inputs).map(i => i.value).join("");
    if (code.length === 6) {
      verifyBtn.disabled = false;
      verifyBtn.style.opacity = "1";
      verifyBtn.style.pointerEvents = "auto";
    } else {
      verifyBtn.disabled = true;
      verifyBtn.style.opacity = "0.5";
      verifyBtn.style.pointerEvents = "none";
    }
  }
  
  // Handle verify button click
  verifyBtn.addEventListener("click", () => {
    const enteredCode = Array.from(inputs).map(i => i.value).join("");
    console.log("Debug - Entered Code:", enteredCode);
    console.log("Debug - Correct Code:", correctCode);
    
    if (enteredCode === correctCode) {
      // Check if user exists in kudiratUsers
      let allUsers = JSON.parse(localStorage.getItem("kudiratUsers") || "[]");
      console.log("Debug - All Users:", allUsers);
      
      // Try to find user by phone number
      let userIndex = allUsers.findIndex(user => user.number === phone);
      console.log("Debug - User Index:", userIndex);
      
      // If user not found, create a new one
      if (userIndex === -1) {
        console.log("Debug - User not found, creating new user");
        const newUser = {
          number: phone,
          accountNumber: accountNumber,
          verificationCode: correctCode,
          verified: false,
          profileComplete: false,
          loginPIN: null,
          createdAt: new Date().toISOString()
        };
        
        allUsers.push(newUser);
        localStorage.setItem("kudiratUsers", JSON.stringify(allUsers));
        
        // Get the index of the newly created user
        const updatedUsers = JSON.parse(localStorage.getItem("kudiratUsers") || "[]");
        userIndex = updatedUsers.findIndex(user => user.number === phone);
        console.log("Debug - New User Index:", userIndex);
      }
      
      // If we still can't find the user, something is wrong
      if (userIndex === -1) {
        errorMsg.textContent = "Error creating user account. Please try again.";
        errorMsg.style.display = "block";
        return;
      }
      
      // Mark user as verified
      allUsers[userIndex].verified = true;
      localStorage.setItem("kudiratUsers", JSON.stringify(allUsers));
      
      // Remove verification code for security
      localStorage.removeItem("verificationCode");
      localStorage.removeItem("verificationCodeExpiry");
      
      // Set session timestamp
      localStorage.setItem("sessionTimestamp", Date.now().toString());
      
      console.log("Debug - User after verification:", allUsers[userIndex]);
      
      errorMsg.style.display = "none";
      window.location.href = "profile-setup.html";
    } else {
      errorMsg.textContent = "Invalid code. Please try again.";
      errorMsg.style.display = "block";
    }
  });
  
  // Resend code logic
  let countdown = 30;
  let timer = setInterval(() => {
    countdown--;
    timerDisplay.textContent = countdown;
    if (countdown <= 0) {
      clearInterval(timer);
      resendBtn.textContent = "Resend Code";
      resendBtn.style.cursor = "pointer";
    }
  }, 1000);
  
  // Handle resend button click
  resendBtn.addEventListener("click", () => {
    if (countdown <= 0) {
      const newCode = Math.floor(100000 + Math.random() * 900000).toString();
      localStorage.setItem("verificationCode", newCode);
      
      // Set new expiry time (30 minutes from now)
      const expiryTime = new Date().getTime() + (30 * 60 * 1000);
      localStorage.setItem("verificationCodeExpiry", expiryTime.toString());
      
      alert("Your new Kudirat Wallet verification code is: " + newCode);
      
      countdown = 30;
      timerDisplay.textContent = countdown;
      resendBtn.innerHTML = `Resend Code (<span id="timer">${countdown}</span>s)`;
      resendBtn.style.cursor = "default";
      
      // Restart countdown timer
      clearInterval(timer);
      timer = setInterval(() => {
        countdown--;
        document.getElementById("timer").textContent = countdown;
        if (countdown <= 0) {
          clearInterval(timer);
          resendBtn.textContent = "Resend Code";
          resendBtn.style.cursor = "pointer";
        }
      }, 1000);
    }
  });
});
</script>
</body>
</html>